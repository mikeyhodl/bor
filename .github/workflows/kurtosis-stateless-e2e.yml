name: Stateless Sync E2E Tests

on:
  push:
    branches:
      - 'master'
      - 'develop'
  pull_request:
    branches:
      - 'master'
      - 'develop'
    types: [opened, synchronize]

concurrency:
  group: stateless-sync-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  ENCLAVE_NAME: kurtosis-stateless-e2e
  POLYCLI_VERSION: v0.1.102

jobs:
  build-bor:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout bor
        uses: actions/checkout@v5

      - name: Build docker image
        run: docker build -t bor:local --file Dockerfile .

      - name: Save image
        run: docker save bor:local | gzip > bor-image.tar.gz

      - name: Upload image
        uses: actions/upload-artifact@v4
        with:
          name: bor-image
          path: bor-image.tar.gz
          retention-days: 1

  build-heimdall-v2:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout heimdall-v2
        uses: actions/checkout@v5
        with:
          repository: 0xPolygon/heimdall-v2
          ref: develop

      - name: Build docker image
        run: docker build -t heimdall-v2:local --file Dockerfile .

      - name: Save image
        run: docker save heimdall-v2:local | gzip > heimdall-v2-image.tar.gz

      - name: Upload image
        uses: actions/upload-artifact@v4
        with:
          name: heimdall-v2-image
          path: heimdall-v2-image.tar.gz
          retention-days: 1

  e2e-tests:
    needs:
      - build-bor
      - build-heimdall-v2
    runs-on: ubuntu24.04-16core-64GB-600SSD-bor
    timeout-minutes: 45
    # These permissions are required to log in to GCR
    permissions:
      contents: read
      actions: write
      id-token: write
    steps:
      # Set up kurtosis
      - name: Checkout kurtosis-pos
        uses: actions/checkout@v5
        with:
          repository: 0xPolygon/kurtosis-pos
          ref: hv2/tx-eip1559-gas-price-configs

      # This step will free disk space and thus remove any docker images previously built
      - name: Pre kurtosis run
        uses: ./.github/actions/kurtosis-pre-run
        with:
          docker_username: ${{ secrets.DOCKERHUB }}
          docker_token: ${{ secrets.DOCKERHUB_KEY }}

      - name: Checkout pos-workflows
        uses: actions/checkout@v5
        with:
          repository: 0xPolygon/pos-workflows
          ref: main
          path: pos-workflows

      - name: Copy kurtosis config
        run: cp ./pos-workflows/.github/configs/kurtosis-stateless-e2e.yml ./kurtosis-stateless-e2e.yml

      # Load images
      - name: Download bor image
        uses: actions/download-artifact@v4
        with:
          name: bor-image

      - name: Download heimdall-v2 image
        uses: actions/download-artifact@v4
        with:
          name: heimdall-v2-image

      - name: Load bor image
        run: |
          gunzip -c bor-image.tar.gz | docker load
          echo "Loaded bor image:"
          docker images bor:local --format "{{.ID}} {{.CreatedAt}}"

      - name: Load heimdall-v2 image
        run: |
          gunzip -c heimdall-v2-image.tar.gz | docker load
          echo "Loaded heimdall-v2 image:"
          docker images heimdall-v2:local --format "{{.ID}} {{.CreatedAt}}"
      
      # Deploy kurtosis enclave
      - name: Kurtosis run
        run: kurtosis run --args-file=kurtosis-stateless-e2e.yml --enclave ${{ env.ENCLAVE_NAME }} .

      - name: Inspect enclave
        run: kurtosis enclave inspect ${{ env.ENCLAVE_NAME }}

      # Run e2e tests
      - name: Install polycli
        run: |
          tmp_dir=$(mktemp -d)
          curl -L https://github.com/0xPolygon/polygon-cli/releases/download/${{ env.POLYCLI_VERSION }}/polycli_${{ env.POLYCLI_VERSION }}_linux_amd64.tar.gz | tar -xz -C "$tmp_dir"
          mv "$tmp_dir"/* /usr/local/bin/polycli
          rm -rf "$tmp_dir"
          sudo chmod +x /usr/local/bin/polycli
          polycli version

      - name: Run stateless sync tests
        working-directory: pos-workflows/tests/stateless_tests
        run: bash kurtosis_stateless_test.sh

      - name: Test state syncs (post VeBlop HF)
        run: kurtosis service exec ${{ env.ENCLAVE_NAME }} test-runner "bats --filter 'bridge MATIC/POL, ERC20, and ERC721 from L1 to L2 and confirm L2 balances increased' tests/pos/bridge.bats"

      # Clean up
      - name: Post kurtosis run
        if: always()
        uses: ./.github/actions/kurtosis-post-run
        with:
          enclave_name: ${{ env.ENCLAVE_NAME }}
